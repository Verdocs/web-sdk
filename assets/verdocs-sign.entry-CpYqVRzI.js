import{r as I,c as v,h as l,H as m,F as _}from"./preview-X13RbvS2.js";import{V as S,w as E,k as R,x as N,y as L,z as D,A,B as C,C as V,D as G,E as M,F as P,G as T,H as z,I as B,i as U}from"./index-CL2BROP6.js";import{a as Y,u as q,g as $,r as x}from"./utils-2cf884a7-7ztE_qbo.js";import{a as H}from"./TemplateFieldStore-d7516adf-DPqtitkf.js";import{V as O}from"./Toast-b71de686-C5I_O3Ev.js";import{S as g}from"./errors-887f1e88-DR-_BPTJ.js";import"./chunk-QN4WKJDJ-Bf_F3oir.js";import"./iframe-DWV1oore.js";import"../sb-preview/runtime.js";import"./Types-e4a6eba5-BiEcJ5ex.js";import"./index-fc5a08b9-CmPFFxNR.js";import"./index-296aabaf-BfkBbDig.js";const W='@-webkit-keyframes verdocs-field-pulse{0%{background-color:rgba(0, 0, 0, 0.35)}50%{background-color:rgba(0, 0, 0, 0)}100%{background-color:rgba(0, 0, 0, 0.35)}}@keyframes verdocs-field-pulse{0%{background-color:rgba(0, 0, 0, 0.35)}50%{background-color:rgba(0, 0, 0, 0)}100%{background-color:rgba(0, 0, 0, 0.35)}}verdocs-sign{display:-ms-flexbox;display:flex;overflow:hidden;position:relative;min-height:600px;-ms-flex-direction:column;flex-direction:column;-webkit-box-sizing:border-box;box-sizing:border-box;font-family:"Inter", -apple-system, "Segoe UI", "Roboto", "Helvetica Neue", sans-serif}verdocs-sign div{display:block;-webkit-box-sizing:border-box;box-sizing:border-box}verdocs-sign input{vertical-align:top}verdocs-sign>.document{-ms-flex:1;flex:1;width:100%;height:100%;-ms-flex-item-align:center;align-self:center;display:-ms-flexbox;display:flex;padding:15px;row-gap:15px;max-width:1200px;min-height:200px;position:relative;overflow-y:scroll;-ms-flex-align:center;align-items:center;-webkit-box-sizing:border-box;box-sizing:border-box;-ms-flex-direction:column;flex-direction:column}verdocs-sign>.document .inner{width:100%;max-width:1028px}verdocs-sign .cover{top:0;left:0;right:0;bottom:0;display:-ms-flexbox;display:flex;z-index:5000;position:absolute;padding-top:100px;-ms-flex-align:center;align-items:center;-ms-flex-direction:column;flex-direction:column;background:rgba(0, 0, 0, 0.5)}verdocs-sign .agree{-ms-flex:0;flex:0;width:600px;display:-ms-flexbox;display:flex;max-width:90%;padding:30px 15px;-ms-flex-direction:column;flex-direction:column;background-color:#ffffff}verdocs-sign .agree .header{-ms-flex:0 0 56px;flex:0 0 56px}verdocs-sign .agree li{margin:0.5em 0}verdocs-sign verdocs-ok-dialog .background-overlay{-ms-flex-align:start;align-items:flex-start;padding-top:100px}verdocs-sign .loading-indicator{top:0;left:0;right:0;bottom:0;display:-ms-flexbox;display:flex;z-index:10000;position:fixed;background-color:rgba(0, 0, 0, 0.7)}@media print{verdocs-sign .header{display:none}}#verdocs-sign-header{color:#fff;width:100%;display:-ms-flexbox;display:flex;z-index:1000;-ms-flex:0 0 56px;flex:0 0 56px;font-size:12px;-webkit-column-gap:15px;-moz-column-gap:15px;column-gap:15px;-ms-flex-align:center;align-items:center;-ms-flex-direction:row;flex-direction:row;-webkit-transition:all 0.25s;transition:all 0.25s;background-color:#33354c;-webkit-box-shadow:0 4px 4px 0 rgba(0, 0, 0, 0.24), 0 0 4px 0 rgba(0, 0, 0, 0.12);box-shadow:0 4px 4px 0 rgba(0, 0, 0, 0.24), 0 0 4px 0 rgba(0, 0, 0, 0.12)}#verdocs-sign-header .inner{width:100%;display:-ms-flexbox;display:flex;margin:0 auto;padding:0 20px;max-width:1200px;-ms-flex-align:center;align-items:center;-ms-flex-direction:row;flex-direction:row}#verdocs-sign-header .logo{width:80px;display:none;margin:-6px 0 0 0}#verdocs-sign-header .title{font-size:18px;font-weight:500;overflow:hidden;white-space:nowrap;padding:0 10px 0 0;text-overflow:ellipsis}',X=W,j=[{id:"later",label:"Finish Later"},{id:"decline",label:"Decline to Sign"},{id:"print",label:"Print Without Signing"},{id:"download",label:"Download"}],J=[{id:"print",label:"Print"},{id:"download",label:"Download"}],K=class{constructor(e){I(this,e),this.sdkError=v(this,"sdkError",7),this.envelopeLoaded=v(this,"envelopeLoaded",7),this.envelopeUpdated=v(this,"envelopeUpdated",7),this.endpoint=null,this.recipientIndex=-1,this.envelopeId=null,this.roleId=null,this.inviteCode=null,this.headerTargetId=null,this.envelope=null,this.roleNames=[],this.sortedRecipients=[],this.recipient=null,this.signerToken=null,this.hasSignature=!1,this.nextButtonLabel="Start",this.nextSubmits=!1,this.errorMessage="",this.focusedField="",this.submitting=!1,this.isDone=!1,this.showDone=!1,this.showLoadError=!1,this.finishLater=!1,this.showFinishLater=!1,this.agreed=!1,this.documentsSingularPlural="document"}componentWillLoad(){this.endpoint=new S({sessionType:"signing"})}async componentWillRender(){var e,i,t,n,s,o,d;if(!this.envelopeId){(e=this.sdkError)===null||e===void 0||e.emit(new g("[SIGN] Missing required envelopId",500,""));return}if(!this.roleId){(i=this.sdkError)===null||i===void 0||i.emit(new g("[SIGN] Missing required roleId",500,""));return}if(!this.inviteCode){(t=this.sdkError)===null||t===void 0||t.emit(new g("[SIGN] Missing required inviteCode",500,""));return}try{console.log(`[SIGN] Processing invite code for ${this.envelopeId} / ${this.roleId}`);const{session:a,recipient:r,signerToken:c}=await E(this.endpoint,{envelopeId:this.envelopeId,roleId:this.roleId,inviteCode:this.inviteCode});console.log(`[SIGN] Loaded signing session ${a.email} / ${a.profile_id}`),this.recipient=r,console.log("[SIGN] We are recipient",this.recipient),this.signerToken=c,this.endpoint.setToken(c),this.agreed&&(this.nextButtonLabel="Next"),this.envelope=await R(this.endpoint,this.envelopeId),H(this.envelope),this.sortedRecipients=[...this.envelope.recipients],this.sortedRecipients.sort((h,p)=>h.sequence===p.sequence?h.order-p.order:h.sequence-p.sequence),this.roleNames=this.sortedRecipients.map(h=>h.role_name),this.envelope.documents.length>0&&(this.documentsSingularPlural="document(s)"),this.recipientIndex=this.roleNames.findIndex(h=>h==this.roleId),this.recipientIndex>-1?(this.recipient=this.sortedRecipients[this.recipientIndex],this.agreed=this.recipient.agreed,console.log("[SIGN] Found our recipient in the envelope",this.recipientIndex,this.recipient)):console.log("[SIGN] Could not find our recipient record",this.roleId,this.sortedRecipients),this.isDone=["submitted","canceled","declined"].includes(this.recipient.status),this.checkRecipientFields(),(n=this.envelopeLoaded)===null||n===void 0||n.emit({endpoint:this.endpoint,envelope:this.envelope})}catch(a){console.log("Error with signing session",a),(s=this.sdkError)===null||s===void 0||s.emit(new g(a.message,(o=a.response)===null||o===void 0?void 0:o.status,(d=a.response)===null||d===void 0?void 0:d.data)),this.showLoadError=!0}}componentDidRender(){const e=this.headerTargetId?document.getElementById(this.headerTargetId):null,i=document.getElementById("verdocs-sign-header");e&&i&&(console.log("[SIGN] Moving header"),i.remove(),e.append(i))}handleClickAgree(){this.submitting=!0,N(this.endpoint,this.envelopeId,this.roleId,!0).then(()=>{var e;this.nextButtonLabel="Next",this.recipient.agreed=!0,this.submitting=!1,this.agreed=!0,(e=this.envelopeUpdated)===null||e===void 0||e.emit({endpoint:this.endpoint,envelope:this.envelope,event:"agreed"})}).catch(e=>{var i,t,n;console.log("Update failure",e),this.submitting=!1,(i=this.sdkError)===null||i===void 0||i.emit(new g(e.message,(t=e.response)===null||t===void 0?void 0:t.status,(n=e.response)===null||n===void 0?void 0:n.data))})}async handleOptionSelected(e){var i,t,n,s,o;switch(e.detail.id){case"later":this.finishLater=!0,this.showFinishLater=!0,(i=this.envelopeUpdated)===null||i===void 0||i.emit({endpoint:this.endpoint,envelope:this.envelope,event:"later"});break;case"claim":O("This feature will be available in an upcoming release."),(t=this.envelopeUpdated)===null||t===void 0||t.emit({endpoint:this.endpoint,envelope:this.envelope,event:"claimed"});break;case"decline":{this.submitting=!0;const d=await L(this.endpoint,this.envelopeId,this.roleId);console.log("Decline result",d),(n=this.envelopeUpdated)===null||n===void 0||n.emit({endpoint:this.endpoint,envelope:this.envelope,event:"declined"}),this.submitting=!1,this.isDone=!0}break;case"print":window.print(),(s=this.envelopeUpdated)===null||s===void 0||s.emit({endpoint:this.endpoint,envelope:this.envelope,event:"printed"});break;case"download":{const d=this.envelope.documents.find(a=>a.type==="attachment");d&&(Y(this.endpoint,this.envelope,d.id).catch(a=>{console.log("Error downloading PDF",a)}),(o=this.envelopeUpdated)===null||o===void 0||o.emit({endpoint:this.endpoint,envelope:this.envelope,event:"downloaded"}))}break}}updateRecipientFieldValue(e,i){console.log("[SIGN] updateRecipientFieldValue",e),this.getRecipientFields().forEach(t=>{t.name===e&&(t.settings=i.settings,q(t),this.checkRecipientFields())})}saveFieldChange(e,i){console.log("[SIGN] updateRecipientFieldValue",e),D(this.endpoint,this.envelopeId,e,i).then(t=>this.updateRecipientFieldValue(e,t)).catch(t=>{var n,s,o,d,a,r;((n=t.response)===null||n===void 0?void 0:n.status)===401&&((o=(s=t.response)===null||s===void 0?void 0:s.data)===null||o===void 0?void 0:o.error)==="jwt expired"?(console.log("[SIGN] Signing session expired"),this.errorMessage="Signing session expired. Please reload your browser to continue."):console.log("[SIGN] Server error",t),(d=this.sdkError)===null||d===void 0||d.emit(new g(t.message,(a=t.response)===null||a===void 0?void 0:a.status,(r=t.response)===null||r===void 0?void 0:r.data))})}async handleFieldChange(e,i){const{value:t,checked:n}=i.target;switch(e.type){case"textbox":return this.saveFieldChange(e.name,{prepared:!1,value:t});case"checkbox_group":{const r=e.settings.options.map(c=>({id:c.id,checked:i.target.checked}));return this.saveFieldChange(e.name,{prepared:!1,value:{options:r}})}case"radio_button_group":{const r=e.settings.options.map(c=>({id:c.id,selected:i.target.value===c.id}));return this.saveFieldChange(e.name,{prepared:!1,value:{options:r}})}case"dropdown":return this.saveFieldChange(e.name,{prepared:!1,value:i.detail});case"initial":if(!i.detail)return;const s=await(await fetch(i.detail)).blob();return V(this.endpoint,"initial",s).then(async r=>{const c=await G(this.endpoint,this.envelopeId,e.name,r.id);this.updateRecipientFieldValue(e.name,c)});case"signature":if(!i.detail)return;const o=await(await fetch(i.detail)).blob();return A(this.endpoint,"signature",o).then(async r=>{console.log("Signature update result",r);const c=await C(this.endpoint,this.envelopeId,e.name,r.id);this.updateRecipientFieldValue(e.name,c)}).catch(r=>{console.warn("Error updating signature",r)});case"date":const{date:d,formattedDate:a}=i.detail;if(a)return console.log("dt",{date:d,formattedDate:a}),this.saveFieldChange(e.name,{prepared:!1,value:a});break;case"timestamp":console.log("Updating timestamp",{value:t,ts:i.target.getAttribute("timestamp")});break;default:console.log("Unhandled field update",{value:t,checked:n},e);break}}isFieldFilled(e){var i,t,n,s,o,d;const{result:a="",value:r="",base64:c=""}=e.settings||{};switch(e.type){case"textbox":switch(e.validator||""){case"email":return P(a);case"phone":return M(a);default:return a!==""}case"signature":case"initial":return c!=="";case"timestamp":return!0;case"textarea":case"date":case"attachment":return a!=="";case"dropdown":return r!=="";case"checkbox_group":const h=(((t=(i=e.settings)===null||i===void 0?void 0:i.options)===null||t===void 0?void 0:t.filter(p=>p.checked))||[]).length;return h>=(((n=e.settings)===null||n===void 0?void 0:n.minimum_checked)||0)&&h<=(((s=e.settings)===null||s===void 0?void 0:s.maximum_checked)||999);case"radio_button_group":return(((d=(o=e.settings)===null||o===void 0?void 0:o.options)===null||d===void 0?void 0:d.filter(p=>p.selected))||[]).length>0;default:return!1}}isFieldValid(e){const{required:i=!1}=e;return!i||this.isFieldFilled(e)}getSortedFillableFields(){const e=this.getRecipientFields().filter(i=>i.type!=="timestamp");return e.sort((i,t)=>{var n,s,o,d;const a=((n=i.settings)===null||n===void 0?void 0:n.x)||0,r=((s=i.settings)===null||s===void 0?void 0:s.y)||0,c=((o=t.settings)===null||o===void 0?void 0:o.x)||0,h=((d=t.settings)===null||d===void 0?void 0:d.y)||0,p=Math.floor(r/5),u=Math.floor(h/5);return u!==p?u-p:a-c}),e}async handleNext(){var e,i;if(this.nextSubmits){try{(e=document.getElementById("air-datepicker-global-container"))===null||e===void 0||e.remove(),this.submitting=!0;const a=await T(this.endpoint,this.envelopeId,this.roleId);console.log("[SIGN] Submitted successfully",a),this.recipient.status="submitted",this.showDone=!0,this.isDone=!0}catch(a){console.log("[SIGN] Error submitting",a)}this.submitting=!1;return}const t=this.getSortedFillableFields().filter(a=>!this.isFieldFilled(a));t.sort((a,r)=>{var c,h,p,u;const w=((c=a.settings)===null||c===void 0?void 0:c.x)||0,k=((h=a.settings)===null||h===void 0?void 0:h.y)||0,y=((p=r.settings)===null||p===void 0?void 0:p.x)||0,F=((u=r.settings)===null||u===void 0?void 0:u.y)||0,b=Math.floor(k/5),f=Math.floor(F/5);return f!==b?f-b:w-y});let s=t.findIndex(a=>a.name===this.focusedField)+1;s>=t.length&&(s=0);let o=t[s],d=0;if(d<t.length&&["signature","initial"].includes(o.type)&&((i=o.settings)===null||i===void 0?void 0:i.result)==="signed"&&(d++,s++,s>=t.length&&(s=0),o=t[s]),d>=t.length&&(o=null),o){const a=$(o),r=document.getElementById(a);console.log("Jumping to next field",o),r==null||r.focusField(),r==null||r.scrollTo({behavior:"smooth",top:0}),this.focusedField=o.name}}getRecipientFields(){return this.envelope.fields.filter(e=>e.recipient_role===this.recipient.role_name)}checkRecipientFields(){const e=this.getRecipientFields().filter(i=>!this.isFieldValid(i));e.length<1?(this.nextButtonLabel="Finish",this.nextSubmits||(this.nextSubmits=!0)):(console.log("[SIGN] Invalid fields remaining",e),this.nextButtonLabel="Next",this.nextSubmits=!1)}attachFieldAttributes(e,i,t){var n;t.addEventListener("input",s=>{s.target.name.includes("date")||s.target.name.includes("checkbox_group")||s.target.name.includes("radio_button_group")?this.handleFieldChange(i,s).finally(()=>this.checkRecipientFields()):this.checkRecipientFields()}),t.addEventListener("attached",async s=>{console.log("[SIGN] onAttached",s.detail,s.target.value);const o=await z(this.endpoint,this.envelopeId,this.roleId,i.name,s.detail);console.log("upload result",o),this.checkRecipientFields()}),t.addEventListener("removed",s=>{console.log("[SIGN] onRemoved",s.detail,s.target.value)}),t.addEventListener("focusout",s=>this.handleFieldChange(i,s).finally(()=>this.checkRecipientFields())),t.addEventListener("fieldChange",s=>this.handleFieldChange(i,s).finally(()=>this.checkRecipientFields())),t.setAttribute("templateid",this.envelope.template_id),t.setAttribute("fieldname",i.name),t.setAttribute("page",e.pageNumber),t.setAttribute("xScale",e.xScale),t.setAttribute("yScale",e.yScale),t.setAttribute("initials",this.recipient?B(this.recipient.full_name):""),t.setAttribute("name",((n=this.recipient)===null||n===void 0?void 0:n.full_name)||"")}handlePageRendered(e){const i=e.detail;this.getSortedFillableFields().forEach((n,s)=>{if(n.page!==i.pageNumber)return;const o=x(n,i,{disabled:!1,editable:!1,draggable:!1,done:this.isDone},s);o&&(Array.isArray(o)?o.map(d=>this.attachFieldAttributes(i,n,d)):this.attachFieldAttributes(i,n,o))}),this.sortedRecipients.filter(n=>n.role_name!==this.recipient.role_name&&(n.status==="invited"||n.status==="opened"||n.status==="pending")).forEach(()=>{this.getRecipientFields().filter(n=>n.page===i.pageNumber).forEach(n=>{const s=x(n,i,{disabled:!0,editable:!1,draggable:!1,done:this.isDone});s&&(Array.isArray(s)?s.map(o=>this.attachFieldAttributes(i,n,o)):this.attachFieldAttributes(i,n,s))})}),this.checkRecipientFields()}render(){return this.envelope?this.isDone?l(m,{class:{agreed:this.agreed}},l("verdocs-view",{endpoint:this.endpoint,envelopeId:this.envelopeId,onSdkError:e=>{var i;return(i=this.sdkError)===null||i===void 0?void 0:i.emit(e.detail)}}),this.errorMessage&&l("verdocs-ok-dialog",{heading:"Network Error",message:this.errorMessage,onNext:()=>this.errorMessage=""}),this.showDone&&l("verdocs-ok-dialog",{heading:"You're Done!",message:`You can access the ${this.documentsSingularPlural} at any time by clicking on the link from the invitation email.<br /><br />After all recipients have completed their actions, you will receive an email with the document and envelope certificate attached.`,onNext:()=>{this.showDone=!1,this.isDone=!0}}),this.submitting&&l("div",{class:"loading-indicator"},l("verdocs-loader",null))):l(m,{class:{agreed:this.agreed}},l("div",{id:"verdocs-sign-header"},l("div",{class:"inner"},l("img",{src:"https://verdocs.com/assets/white-logo.svg",alt:"Verdocs Logo",class:"logo"}),l("div",{class:"title"},this.envelope.name),l("div",{style:{flex:"1"}}),this.agreed&&!this.finishLater&&l("verdocs-button",{size:"small",label:this.nextButtonLabel,disabled:!this.agreed,onClick:()=>this.handleNext()}),l("div",{style:{marginLeft:"10px"}}),this.agreed&&l("verdocs-dropdown",{options:!this.isDone&&!this.finishLater?j:J,onOptionSelected:e=>this.handleOptionSelected(e)}))),l("div",{class:"document",style:{paddingTop:"15px"}},(this.envelope.documents||[]).map(e=>{const i=U(1,e.pages);return l(_,null,i.map(t=>l("verdocs-envelope-document-page",{envelopeId:this.envelopeId,documentId:e.id,endpoint:this.endpoint,virtualWidth:612,virtualHeight:792,pageNumber:t,onPageRendered:n=>this.handlePageRendered(n),type:"filled",layers:[{name:"page",type:"canvas"},{name:"controls",type:"div"}]})))})),this.showFinishLater&&l("verdocs-ok-dialog",{heading:"You've saved your document to finish later.",message:`To complete the ${this.documentsSingularPlural}, use the link in the original email notification inviting you to review and finish the document.`,onNext:()=>this.showFinishLater=!1}),this.errorMessage&&l("verdocs-ok-dialog",{heading:"Network Error",message:this.errorMessage,onNext:()=>this.errorMessage=""}),this.showDone&&l("verdocs-ok-dialog",{heading:"You're Done!",message:`You can access the ${this.documentsSingularPlural} at any time by clicking on the link from the invitation email.<br /><br />After all recipients have completed their actions, you will receive an email with the document and envelope certificate attached.`,onNext:()=>{this.showDone=!1,this.isDone=!0}}),this.showLoadError&&l("verdocs-ok-dialog",{heading:"Error Loading Document",message:"Please check with the sender to ensure it has not been canceled, and try again later.",buttonLabel:"Retry",onNext:()=>{this.showLoadError=!1,window.location.reload()}}),this.submitting&&l("div",{class:"loading-indicator"},l("verdocs-loader",null)),!this.agreed&&l("div",{class:"cover"},l("div",{class:"agree"},l("verdocs-checkbox",{name:"agree",label:"By checking this box, you:",onInput:()=>this.handleClickAgree()}),l("ul",null,l("li",null,"Agree to use electronic records and signatures, and confirm you have read the"," ",l("a",{href:"https://verdocs.com/en/electronic-record-signature-disclosure/",target:"_blank"},"Electronic Record and Signatures Disclosure"),"."),l("li",null,"Agree to Verdocs"," ",l("a",{href:"https://verdocs.com/en/eula",target:"_blank"},"End User License Agreement")," ","and confirm you have read Verdocs'"," ",l("a",{href:"https://verdocs.com/en/privacy-policy/",target:"_blank"},"Privacy Policy"),"."))))):l(m,null,l("verdocs-loader",null))}};K.style=X;export{K as verdocs_sign};
